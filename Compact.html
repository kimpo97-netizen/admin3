import React, { useState, useEffect } from 'react';
import { Search, MapPin, Calendar, Clock, ArrowRight, Smartphone, User, FileText, Package, Zap, SlidersHorizontal, X, Save, Plus, Trash2, Building, AlertCircle, RefreshCw, CheckCircle, Loader2, StickyNote } from 'lucide-react';

// 여기에 배포한 구글 앱스 스크립트 URL을 입력하세요.
const GOOGLE_SHEET_URL = "https://script.google.com/macros/s/AKfycbzYaaFMrSE495T4nI97MmW6r43svqTzxhPpbiEqudOIC0FLSoQ2tD1QZ9X6KM46fVe_Gw/exec"; 

// --- 헬퍼 함수 (컴포넌트 외부 정의) ---

// 날짜 문자열(YY.MM.DD)을 Date 객체로 변환하는 헬퍼 함수
const parseDateStr = (dateStr) => {
  if (!dateStr) return new Date(0);
  const str = String(dateStr);
  // ISO string
  if (str.includes('-') || str.includes('T')) {
      return new Date(str);
  }
  // YY.MM.DD
  const parts = str.split('.');
  if (parts.length === 3) {
      const [yy, mm, dd] = parts.map(Number);
      return new Date(2000 + yy, mm - 1, dd);
  }
  return new Date(str); // Fallback
};

// 기준 날짜 계산 (D-2) - 컴포넌트 외부로 이동
const getThresholdDate = () => {
  const date = new Date();
  date.setDate(date.getDate() - 2); // 2일 전
  date.setHours(0, 0, 0, 0); // 시간 초기화
  return date;
};

// 모델명 축약 및 정규화 (S 제외 유지)
const getShortModelName = (fullModelName) => {
  if (!fullModelName) return "";
  let name = fullModelName.toUpperCase()
    .replace('GALAXY', '')
    .replace('갤럭시', '')
    .replace('IPHONE', '')
    .replace('아이폰', '')
    .trim();

  name = name.replace('ULTRA', 'U').replace('울트라', 'U');
  name = name.replace('PRO', 'P').replace('프로', 'P');
  name = name.replace('MAX', 'M').replace('맥스', 'M');
  name = name.replace('PLUS', '+').replace('플러스', '+');
  
  // 공백 제거
  name = name.replace(/\s/g, '');

  // S로 시작하고 바로 뒤에 숫자가 오는 경우 (예: S23U -> 23U) S 제거
  if (name.startsWith('S') && /^\d/.test(name.slice(1))) {
    name = name.substring(1);
  }

  return name;
};

// 모델 필터 매칭 로직 (S 없는 키워드 기준)
const isModelMatch = (orderModel, filterKey) => {
  const shortName = getShortModelName(orderModel); // 결과 예: 23U, 24U, 17PM

  if (filterKey === '전체') return true;

  // 갤럭시 시리즈 (23U, 24U, 25U)
  if (['23U', '24U', '25U'].includes(filterKey)) {
    return shortName.startsWith(filterKey.replace('U', '')); 
  }
  
  // 아이폰 17 시리즈 구분 (17P vs 17PM)
  if (filterKey === '17P') {
    return shortName === '17P' || (shortName.includes('17P') && !shortName.includes('M'));
  }
  if (filterKey === '17PM') {
    return shortName === '17PM' || shortName.includes('17PM');
  }
  
  return shortName.includes(filterKey);
};

// 전화번호 포맷팅
const formatPhoneNumber = (value) => {
  const numbers = value.replace(/[^\d]/g, '');
  if (numbers.length <= 3) return numbers;
  if (numbers.length <= 7) return `${numbers.slice(0, 3)}-${numbers.slice(3)}`;
  return `${numbers.slice(0, 3)}-${numbers.slice(3, 7)}-${numbers.slice(7, 11)}`;
};

// 날짜 포맷팅 (YYYY.MM.DD -> YY.MM.DD)
const safeFormatDate = (dateStr) => {
  if (!dateStr) return '';
  const str = String(dateStr).trim();
  if (/^\d{2}\.\d{2}\.\d{2}$/.test(str)) return str;
  if (/^\d{4}\.\d{2}\.\d{2}$/.test(str)) return str.slice(2);
  try {
    const d = new Date(str);
    if (isNaN(d.getTime())) return str;
    const year = d.getFullYear().toString().slice(-2);
    const month = ('0' + (d.getMonth() + 1)).slice(-2);
    const day = ('0' + d.getDate()).slice(-2);
    return `${year}.${month}.${day}`;
  } catch (e) {
    return str;
  }
};

// 상태별 컬러 라인 스타일
const getStatusColor = (status) => {
  switch (status) {
    case '예약확정': return 'bg-blue-500';
    case '대여중': return 'bg-green-500';
    case '반납완료': return 'bg-gray-300';
    case '연체중': return 'bg-red-500';
    case '취소': return 'bg-orange-400';
    default: return 'bg-gray-300';
  }
};

// 상태별 배지 스타일
const getStatusBadgeStyle = (status) => {
  switch (status) {
    case '예약확정': return 'bg-blue-50 text-blue-600 border-blue-100';
    case '대여중': return 'bg-green-50 text-green-600 border-green-100';
    case '반납완료': return 'bg-gray-50 text-gray-500 border-gray-100';
    case '연체중': return 'bg-red-50 text-red-600 border-red-100';
    case '취소': return 'bg-orange-50 text-orange-600 border-orange-100';
    default: return 'bg-gray-50 text-gray-500 border-gray-100';
  }
};

// 탭 아이콘 렌더링 (이전 버전 아이콘으로 복구)
const renderTabIcon = (label) => {
  if (label === '택배') return <Package className="w-3 h-3" />;
  if (label === '공연장') return <MapPin className="w-3 h-3" />;
  if (label === '퀵') return <Zap className="w-3 h-3" />;
  if (label === '사무실') return <Building className="w-3 h-3" />;
  return null;
};

// --- 컴포넌트 시작 ---
const RentalAdminCompact = () => {
  const [dateFilters, setDateFilters] = useState([]);
  const [modelFilter, setModelFilter] = useState('전체');
  const [methodFilter, setMethodFilter] = useState('전체');
  const [searchTerm, setSearchTerm] = useState('');
  
  const [isLoading, setIsLoading] = useState(false);
  const [selectedOrder, setSelectedOrder] = useState(null);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [deviceInput, setDeviceInput] = useState('');
  const [isOfflineMode, setIsOfflineMode] = useState(false);

  // 초기 샘플 데이터
  const initialData = [
    { id: 1, time: '14:30', model: 'Galaxy S23 Ultra', qty: 1, user: '김민지', phone: '010-1234-5678', start: '25.12.25', event: '세븐틴 고척 콘서트', pickup: '택배', return: '택배', status: '예약확정', assigned: [], memo: '입금 확인 필요' },
    { id: 2, time: '13:15', model: 'iPhone 17 Pro Max', qty: 2, user: '이서연', phone: '010-9876-5432', start: '25.12.26', event: 'NCT 127 팬미팅', pickup: '공연장', return: '공연장', status: '대여중', assigned: ['17PM02', '17PM05'], memo: '단골 고객' },
    { id: 5, time: '10:00', model: 'iPhone 17 Pro', qty: 1, user: '정하나', phone: '010-1111-2222', start: '25.12.25', event: '세븐틴 고척 막콘', pickup: '공연장', return: '공연장', status: '연체중', assigned: ['17P09'], memo: '' },
    { id: 3, time: '09:00', model: '23u', qty: 1, user: '박지민', phone: '010-4444-5555', start: '25.12.28', event: '개인 촬영', pickup: '택배', return: '택배', status: '반납완료', assigned: ['23U18'], memo: '' },
    { id: 4, time: '11:20', model: 'Galaxy S24 Ultra', qty: 1, user: '최수영', phone: '010-9999-0000', start: '25.12.29', event: '아이브 콘서트', pickup: '퀵', return: '택배', status: '예약확정', assigned: [], memo: '' },
    { id: 6, time: '15:45', model: 'Galaxy S25 Ultra', qty: 2, user: '강다니엘', phone: '010-2222-3333', start: '26.01.05', event: '골든디스크', pickup: '택배', return: '택배', status: '예약확정', assigned: [], memo: '' },
    { id: 8, time: '14:30', model: 'Galaxy S23 Ultra', qty: 1, user: '김민지', phone: '010-1234-1234', start: '25.12.25', event: '친구랑 대여', pickup: '사무실', return: '사무실', status: '예약확정', assigned: [], memo: '신분증 지참 안내함' },
    { id: 9, time: '16:00', model: 'iPhone 17 Pro', qty: 1, user: '장원영', phone: '010-3333-4444', start: '25.12.25', event: '크리스마스 파티', pickup: '퀵', return: '퀵', status: '예약확정', assigned: [], memo: '' },
  ];

  const [orders, setOrders] = useState(initialData);

  const isDuplicateName = (currentOrder) => {
    return orders.filter(o => 
      o.start === currentOrder.start && 
      o.user.replace(/\s/g, '') === currentOrder.user.replace(/\s/g, '') 
    ).length > 1;
  };

  const fetchOrders = async () => {
    setIsLoading(true);
    setIsOfflineMode(false);

    try {
      if (!GOOGLE_SHEET_URL) throw new Error("URL 없음");

      const response = await fetch(GOOGLE_SHEET_URL);
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      
      const data = await response.json();
      if (Array.isArray(data)) {
        setOrders(data.map(item => ({
          ...item,
          assigned: item.assigned || [], // F열
          qty: parseInt(item.qty) || 1,
          memo: item.memo || '', // P열
          start: safeFormatDate(item.start) 
        })));
      } else {
        throw new Error("데이터 형식 오류");
      }

    } catch (error) {
      console.warn("시트 연동 실패 (로컬 데이터 사용):", error);
      setIsOfflineMode(true);
      if(orders.length === 0) setOrders(initialData);
    } finally {
      setIsLoading(false);
    }
  };

  useEffect(() => {
    fetchOrders();
  }, []);

  const handleSaveChanges = async () => {
    setOrders(prev => prev.map(o => o.id === selectedOrder.id ? selectedOrder : o));
    setIsModalOpen(false);

    if (GOOGLE_SHEET_URL && !isOfflineMode) {
      try {
        await fetch(GOOGLE_SHEET_URL, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "update", ...selectedOrder }),
        });
      } catch (error) {
        console.error("Save Error:", error);
      }
    }
  };

  const handleQuickReturn = async (e, orderId) => {
    e.stopPropagation();
    const targetOrder = orders.find(o => o.id === orderId);
    if (!targetOrder) return;

    const updatedOrder = { ...targetOrder, status: '반납완료' };
    setOrders(prev => prev.map(o => o.id === orderId ? updatedOrder : o));
    
    if (GOOGLE_SHEET_URL && !isOfflineMode) {
      try {
        await fetch(GOOGLE_SHEET_URL, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "update", ...updatedOrder }),
        });
      } catch (error) {
        console.error("Quick Return Error:", error);
      }
    }
  };

  const handleOrderClick = (order) => {
    setSelectedOrder({ ...order });
    setDeviceInput('');
    setIsModalOpen(true);
  };

  const handleCloseModal = () => {
    setIsModalOpen(false);
    setSelectedOrder(null);
  };

  const handleInputChange = (field, value) => {
    if (field === 'phone') {
      value = formatPhoneNumber(value);
    }
    setSelectedOrder(prev => ({ ...prev, [field]: value }));
  };

  const handleAddDevice = () => {
    if (!deviceInput.trim()) return;
    const shortModel = getShortModelName(selectedOrder.model);
    const newDeviceTag = `${shortModel}${deviceInput}`; 
    
    setSelectedOrder(prev => ({
      ...prev,
      assigned: [...(prev.assigned || []), newDeviceTag]
    }));
    setDeviceInput('');
  };

  const handleRemoveDevice = (index) => {
    setSelectedOrder(prev => ({
      ...prev,
      assigned: prev.assigned.filter((_, i) => i !== index)
    }));
  };

  // 필터링 및 검색 로직
  const getFilteredOrders = () => {
    let filtered = orders;

    // [추가] 기본 날짜 필터: D-2 이전 날짜는 리스트에서 숨김
    const thresholdDate = getThresholdDate();
    filtered = filtered.filter(order => {
        const orderDate = parseDateStr(order.start);
        return orderDate >= thresholdDate;
    });

    if (searchTerm) {
      const term = searchTerm.trim().toLowerCase();
      filtered = filtered.filter(order => {
        const isNameMatch = order.user.toLowerCase().includes(term);
        const cleanPhone = order.phone.replace(/-/g, '');
        const lastFour = cleanPhone.slice(-4);
        const isPhoneMatch = term.length >= 4 && (cleanPhone === term || lastFour === term || order.phone === term);
        const isDeviceMatch = order.assigned && order.assigned.some(tag => {
            const match = tag.match(/(\d+)$/);
            const deviceNum = match ? match[1] : '';
            return deviceNum === term; 
        });
        const shortModel = getShortModelName(order.model).toLowerCase();
        const isModelMatch = shortModel.includes(term) || order.model.toLowerCase().includes(term);

        return isNameMatch || isPhoneMatch || isDeviceMatch || isModelMatch;
      });
    }

    if (dateFilters.length > 0) {
      filtered = filtered.filter(order => dateFilters.includes(order.start));
    }

    if (modelFilter !== '전체') {
       filtered = filtered.filter(o => isModelMatch(o.model, modelFilter));
    }

    if (methodFilter !== '전체') {
      filtered = filtered.filter(order => order.pickup === methodFilter);
    }

    return filtered.sort((a, b) => a.start.localeCompare(b.start));
  };

  const filteredOrders = getFilteredOrders();

  const toggleDateFilter = (dateLabel) => {
    if (dateLabel === '전체') { setDateFilters([]); return; }
    setDateFilters(prev => prev.includes(dateLabel) ? prev.filter(d => d !== dateLabel) : [...prev, dateLabel]);
  };

  const getOrdersForDate = () => {
      if(dateFilters.length === 0) return orders;
      return orders.filter(o => dateFilters.includes(o.start));
  };
  const currentFilteredByDate = getOrdersForDate();

  const countByModel = (keyword) => {
    if (keyword === '전체') return currentFilteredByDate.length;
    return currentFilteredByDate.filter(o => isModelMatch(o.model, keyword)).length;
  };

  const countByMethod = (keyword) => {
      let base = currentFilteredByDate;
      if (modelFilter !== '전체') {
          base = base.filter(o => isModelMatch(o.model, modelFilter));
      }
      return base.filter(o => o.pickup === keyword).length;
  };

  // 날짜 목록 생성 (D-2 필터 적용)
  const thresholdDate = getThresholdDate();
  
  const uniqueDates = [...new Set(orders.map(o => o.start))]
    .filter(dateStr => {
      const date = parseDateStr(dateStr);
      return date >= thresholdDate;
    })
    .sort();

  return (
    <div className="min-h-screen bg-gray-50 flex flex-col font-sans select-none">
      
      {/* 상단 헤더 */}
      <div className="sticky top-0 z-20 bg-white shadow-sm pb-1">
        <div className="px-4 pt-4 pb-2">
          <div className="flex justify-between items-center mb-3">
            <h1 className="text-xl font-bold text-gray-900">예약 관리</h1>
            <div className="flex gap-2 items-center">
               {isLoading && <span className="text-xs text-gray-400 flex items-center gap-1"><Loader2 className="w-3 h-3 animate-spin" /> 동기화 중...</span>}
               {isOfflineMode && !isLoading && <span className="text-xs text-orange-500 font-bold flex items-center gap-1">⚠ 오프라인</span>}
               <div className="text-xs font-medium text-gray-500 bg-gray-100 px-2 py-1 rounded-md">
                 Total {orders.length}
               </div>
            </div>
          </div>
          <div className="flex gap-2">
            <div className="relative flex-1">
                <input 
                  type="text" 
                  placeholder="고객명(일부), 연락처(뒷자리), 기기번호 검색" 
                  className="w-full bg-gray-100 text-sm py-2.5 pl-10 pr-4 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all placeholder:text-gray-400"
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                />
                <Search className="absolute left-3 top-2.5 text-gray-400 w-4 h-4" />
            </div>
            <button 
                onClick={fetchOrders}
                className="w-10 h-10 bg-gray-100 rounded-xl flex items-center justify-center text-gray-500 hover:bg-gray-200 hover:text-gray-900 transition-colors active:scale-95 flex-shrink-0"
                aria-label="새로고침"
            >
                <RefreshCw className={`w-4 h-4 ${isLoading ? 'animate-spin' : ''}`} />
            </button>
          </div>
        </div>

        {/* 1. 날짜 필터 */}
        <div className="flex overflow-x-auto px-4 pb-2 gap-1.5 scrollbar-hide">
          <button
            onClick={() => toggleDateFilter('전체')}
            className={`flex items-center justify-center gap-1 px-2.5 py-1 rounded-full text-[10px] font-bold whitespace-nowrap transition-all border min-w-[50px]
              ${dateFilters.length === 0 ? 'bg-gray-900 text-white border-gray-900 shadow-md' : 'bg-white text-gray-600 border-gray-200'}`}
          >
            전체 <span className={`text-[8px] px-1 py-0.5 rounded-full ${dateFilters.length === 0 ? 'bg-white/20 text-white' : 'bg-gray-100 text-gray-500'}`}>{orders.length}</span>
          </button>
          {uniqueDates.map(date => {
            const isActive = dateFilters.includes(date);
            return (
              <button
                key={date}
                onClick={() => toggleDateFilter(date)}
                className={`flex items-center justify-center gap-1 px-2.5 py-1 rounded-full text-[10px] font-bold whitespace-nowrap transition-all border min-w-[50px]
                  ${isActive ? 'bg-gray-900 text-white border-gray-900 shadow-md' : 'bg-white text-gray-600 border-gray-200'}`}
              >
                {date} 
                <span className={`text-[8px] px-1 py-0.5 rounded-full ${isActive ? 'bg-white/20 text-white' : 'bg-gray-100 text-gray-500'}`}>
                  {orders.filter(o => o.start === date).length}
                </span>
              </button>
            );
          })}
        </div>

        {/* 2. 모델 필터 */}
        <div className="flex overflow-x-auto px-4 pb-2 gap-1.5 scrollbar-hide mt-1">
          <div className="flex items-center mr-1 text-gray-400"><Smartphone className="w-3.5 h-3.5" /></div>
          {['전체', '23U', '24U', '25U', '17P', '17PM'].map(tab => {
             // 탭 키워드는 필터링용으로 단순화
             const keyword = tab; 
             const count = countByModel(keyword);
             return (
              <button
                key={tab}
                onClick={() => setModelFilter(keyword)}
                className={`flex items-center justify-center gap-1 px-2.5 py-1 rounded-full text-[11px] font-bold whitespace-nowrap transition-all border min-w-[50px]
                  ${modelFilter === keyword ? 'bg-gray-800 text-white border-gray-800' : 'bg-white text-gray-500 border-gray-100'}
                  ${count === 0 ? 'opacity-40' : ''}`}
              >
                {tab}
                {tab !== '전체' && <span className={`text-[9px] px-1 py-0.5 rounded-full ${modelFilter === keyword ? 'bg-white/20 text-white' : 'bg-gray-100 text-gray-500'}`}>{count}</span>}
              </button>
             );
          })}
        </div>

        {/* 3. 수령방법 필터 (아이콘 복구됨) */}
        <div className="flex overflow-x-auto px-4 pb-2 gap-1.5 scrollbar-hide mt-1">
            <div className="flex items-center mr-1 text-gray-400"><SlidersHorizontal className="w-3.5 h-3.5" /></div>
            {['전체', '공연장', '택배', '퀵', '사무실'].map(label => {
               const count = label === '전체' ? currentFilteredByDate.length : countByMethod(label);
               return (
                <button
                    key={label}
                    onClick={() => setMethodFilter(label)}
                    className={`flex items-center justify-center gap-1 px-2.5 py-1 rounded-full text-[11px] font-bold whitespace-nowrap transition-all border min-w-[55px]
                    ${methodFilter === label ? 'bg-gray-800 text-white border-gray-800' : 'bg-white text-gray-500 border-gray-100'}
                    ${count === 0 ? 'opacity-40' : ''}`}
                >
                    {renderTabIcon(label)}
                    {label}
                    {label !== '전체' && <span className={`text-[9px] px-1 py-0.5 rounded-full ${methodFilter === label ? 'bg-white/20 text-white' : 'bg-gray-100 text-gray-500'}`}>{count}</span>}
                </button>
               );
            })}
        </div>
      </div>

      {/* 리스트 영역 */}
      <div className="flex-1 px-3 py-2 space-y-2 overflow-y-auto pb-20 bg-gray-50">
        {filteredOrders.length === 0 ? (
          <div className="h-64 flex flex-col items-center justify-center text-gray-400">
            {searchTerm ? (
                <div className="text-center">
                  <Search className="w-8 h-8 mb-2 opacity-30 mx-auto" />
                  <p className="text-sm font-medium text-gray-600">검색 결과가 없습니다.</p>
                </div>
            ) : (
                <div className="text-center">
                  <Smartphone className="w-8 h-8 mb-2 opacity-50 mx-auto" />
                  <p className="text-sm">조건에 맞는 예약이 없습니다.</p>
                </div>
            )}
          </div>
        ) : (
          filteredOrders.map((order, index) => {
            const isDup = isDuplicateName(order);
            
            return (
            <div 
              // 키 중복 방지 (ID+Index 조합)
              key={order.id ? `${order.id}-${index}` : index}
              onClick={() => handleOrderClick(order)} 
              className="relative bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden active:scale-[0.98] transition-transform cursor-pointer"
            >
              {/* 상태 컬러 라인 */}
              <div className={`absolute left-0 top-0 bottom-0 w-1.5 ${getStatusColor(order.status).split(' ')[0]}`} />
              
              <div className="pl-4 pr-4 py-3">
                {/* 1. 상단: 모델 & 기기번호 & 이름 & 메모 & 날짜 */}
                <div className="flex justify-between items-center mb-3">
                  <div className="flex items-center gap-2 overflow-hidden flex-1 mr-2">
                    <div className="flex items-center gap-1 flex-shrink-0">
                        <span className="bg-slate-100 text-slate-700 border border-slate-200 text-[11px] font-bold px-1.5 py-0.5 rounded shadow-sm whitespace-nowrap">
                            {getShortModelName(order.model)}
                        </span>
                        {order.assigned && order.assigned.length > 0 && (
                            <div className="flex gap-1">
                                {order.assigned.map((tag, i) => {
                                    const shortModel = getShortModelName(order.model);
                                    const deviceNum = tag.replace(shortModel, '').replace('-', ''); 
                                    return (
                                        <span key={i} className="bg-violet-100 text-violet-600 border border-violet-200 text-[11px] font-bold px-1.5 py-0.5 rounded shadow-sm whitespace-nowrap flex items-center">
                                            {deviceNum}
                                        </span>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                    
                    {/* 이름 & 동명이인 체크 (강조 적용됨) */}
                    <div className="flex items-center gap-1 flex-shrink-0 ml-1 relative">
                      <span className={`font-bold text-sm whitespace-nowrap ${isDup ? 'text-red-600' : 'text-gray-900'}`}>
                        {order.user}
                      </span>
                      {isDup && (
                        <div className="group relative">
                          <AlertCircle className="w-3.5 h-3.5 text-red-600 animate-pulse cursor-help" />
                          <div className="absolute left-1/2 bottom-full mb-1 transform -translate-x-1/2 hidden group-hover:block bg-red-600 text-white text-[10px] px-2 py-1 rounded shadow-lg whitespace-nowrap z-50">
                            동명이인 주의
                          </div>
                        </div>
                      )}
                    </div>
                    
                    {/* 메모 및 행사명 */}
                    <div className="flex items-center truncate min-w-0 ml-1 gap-1.5">
                      <span className="text-xs text-gray-500 truncate">{order.event}</span>
                      {order.memo && order.memo.trim() !== '' && (
                        <span className="text-[10px] bg-amber-50 text-amber-600 px-1.5 py-0.5 rounded border border-amber-100 truncate max-w-[120px] font-medium flex items-center gap-0.5">
                          {order.memo}
                        </span>
                      )}
                    </div>
                  </div>
                  
                  {/* 날짜 및 상태 표시 */}
                  <div className="flex items-center gap-2 flex-shrink-0">
                    <div className="flex items-center">
                      <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded border ${getStatusBadgeStyle(order.status)}`}>
                          {order.status}
                      </span>
                      {/* 빠른 반납 버튼 */}
                      {(order.status === '대여중' || order.status === '연체중') && (
                        <button
                          onClick={(e) => handleQuickReturn(e, order.id)}
                          className="ml-1 bg-white border border-gray-200 text-gray-400 hover:text-green-600 hover:border-green-400 hover:bg-green-50 text-[10px] px-1.5 py-0.5 rounded flex items-center gap-0.5 transition-all shadow-sm"
                        >
                          <CheckCircle className="w-3 h-3" />
                          <span className="leading-none pb-[1px]">반납</span>
                        </button>
                      )}
                    </div>
                    <div className="flex items-center gap-1.5 bg-blue-50 px-2 py-1 rounded-md">
                        <Calendar className="w-3 h-3 text-blue-600" />
                        <span className="text-[10px] font-bold text-blue-700 tracking-tight">
                        {order.start}
                        </span>
                    </div>
                  </div>
                </div>

                {/* 2. 하단: 수령방법 -> 반납방법 */}
                <div className="flex items-center gap-2 text-xs bg-gray-50 p-2 rounded-lg border border-gray-100">
                  <div className="flex items-center gap-1.5 flex-1 justify-center">
                    <span className="text-gray-500">수령</span>
                    <strong className="text-blue-600">{order.pickup}</strong>
                  </div>
                  <ArrowRight className="w-3 h-3 text-gray-300" />
                  <div className="flex items-center gap-1.5 flex-1 justify-center">
                    <span className="text-gray-500">반납</span>
                    <strong className="text-red-500">{order.return}</strong>
                  </div>
                </div>

              </div>
            </div>
            );
          })
        )}
      </div>

      {/* 상세/수정 모달 */}
      {isModalOpen && selectedOrder && (
        <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/50 backdrop-blur-sm animate-fadeIn">
          <div className="bg-white w-full sm:w-[400px] h-[90vh] sm:h-auto sm:max-h-[85vh] rounded-t-2xl sm:rounded-2xl shadow-2xl flex flex-col overflow-hidden animate-slideUp">
            
            <div className="px-5 py-4 border-b border-gray-100 flex justify-between items-center bg-white sticky top-0 z-10">
              <h2 className="text-lg font-bold text-gray-900">예약 상세 / 수정</h2>
              <button onClick={handleCloseModal} className="p-2 -mr-2 text-gray-400 hover:text-gray-600">
                <X className="w-6 h-6" />
              </button>
            </div>

            <div className="flex-1 overflow-y-auto p-5 space-y-6">
              
              {/* 기기 배정 섹션 */}
              <div className="bg-blue-50 p-4 rounded-xl border border-blue-100">
                <label className="text-xs font-bold text-blue-800 mb-2 block flex items-center gap-1">
                   <Smartphone className="w-3.5 h-3.5" /> 기기 배정 (출고 처리)
                </label>
                <div className="flex gap-2 mb-3">
                  <input 
                    type="number" 
                    placeholder="기기 번호 (예: 18)" 
                    className="flex-1 bg-white border border-blue-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                    value={deviceInput}
                    onChange={(e) => setDeviceInput(e.target.value)}
                    onKeyPress={(e) => e.key === 'Enter' && handleAddDevice()}
                  />
                  <button onClick={handleAddDevice} className="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-700">추가</button>
                </div>
                <div className="flex flex-wrap gap-2">
                  {selectedOrder.assigned && selectedOrder.assigned.length > 0 ? (
                    selectedOrder.assigned.map((tag, idx) => {
                      const shortModel = getShortModelName(selectedOrder.model);
                      const deviceNum = tag.replace(shortModel, '').replace('-', '');
                      return (
                        <div key={idx} className="flex items-center gap-1 bg-white border border-blue-200 text-blue-800 px-2 py-1 rounded text-sm font-medium shadow-sm">
                          <span>#{deviceNum}</span>
                          <button onClick={() => handleRemoveDevice(idx)} className="text-blue-400 hover:text-red-500"><X className="w-3 h-3" /></button>
                        </div>
                      )
                    })
                  ) : <p className="text-xs text-blue-400">배정된 기기가 없습니다.</p>}
                </div>
              </div>

              {/* 정보 수정 폼 */}
              <div className="space-y-3">
                <h3 className="text-sm font-bold text-gray-900 flex items-center gap-1"><User className="w-4 h-4" /> 고객 정보</h3>
                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <label className="text-xs text-gray-500 mb-1 block">이름</label>
                    <input type="text" className="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm" value={selectedOrder.user} onChange={(e) => handleInputChange('user', e.target.value)} />
                  </div>
                  <div>
                    <label className="text-xs text-gray-500 mb-1 block">연락처</label>
                    <input type="text" className="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm" value={selectedOrder.phone} onChange={(e) => handleInputChange('phone', e.target.value)} />
                  </div>
                </div>
              </div>

              <div className="space-y-3">
                <h3 className="text-sm font-bold text-gray-900 flex items-center gap-1"><Calendar className="w-4 h-4" /> 일정 및 모델 정보</h3>
                <div>
                   <label className="text-xs text-gray-500 mb-1 block">행사명</label>
                   <input type="text" className="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm" value={selectedOrder.event} onChange={(e) => handleInputChange('event', e.target.value)} />
                </div>
                {/* 관리자 메모 (P열 연동) */}
                <div>
                   <label className="text-xs text-gray-500 mb-1 block flex items-center gap-1"><StickyNote className="w-3 h-3" /> 관리자 메모 (내부용)</label>
                   <textarea 
                      className="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm h-20 resize-none focus:outline-none focus:ring-2 focus:ring-gray-900"
                      value={selectedOrder.memo || ''}
                      onChange={(e) => handleInputChange('memo', e.target.value)}
                      placeholder="특이사항, 단골 여부 등 내부 메모를 입력하세요."
                   />
                </div>
                <div className="grid grid-cols-2 gap-3">
                   <div>
                      <label className="text-xs text-gray-500 mb-1 block">대여 모델</label>
                      <select className="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm" value={selectedOrder.model} onChange={(e) => handleInputChange('model', e.target.value)}>
                        <option value="Galaxy S23 Ultra">23U (Galaxy S23 Ultra)</option>
                        <option value="Galaxy S24 Ultra">24U (Galaxy S24 Ultra)</option>
                        <option value="Galaxy S25 Ultra">25U (Galaxy S25 Ultra)</option>
                        <option value="iPhone 17 Pro">17P (iPhone 17 Pro)</option>
                        <option value="iPhone 17 Pro Max">17PM (iPhone 17 Pro Max)</option>
                      </select>
                   </div>
                   <div>
                      <label className="text-xs text-gray-500 mb-1 block">수량</label>
                      <input type="number" min="1" className="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm" value={selectedOrder.qty} onChange={(e) => handleInputChange('qty', parseInt(e.target.value) || 1)} />
                   </div>
                   <div>
                      <label className="text-xs text-gray-500 mb-1 block">수령 방법</label>
                      <select className="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm" value={selectedOrder.pickup} onChange={(e) => handleInputChange('pickup', e.target.value)}>
                        <option value="공연장">공연장</option>
                        <option value="택배">택배</option>
                        <option value="퀵">퀵</option>
                        <option value="사무실">사무실</option>
                      </select>
                   </div>
                   <div>
                      <label className="text-xs text-gray-500 mb-1 block">반납 방법</label>
                      <select className="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm" value={selectedOrder.return} onChange={(e) => handleInputChange('return', e.target.value)}>
                        <option value="공연장">공연장</option>
                        <option value="택배">택배</option>
                        <option value="퀵">퀵</option>
                        <option value="사무실">사무실</option>
                      </select>
                   </div>
                </div>
              </div>

              <div>
                <h3 className="text-sm font-bold text-gray-900 mb-2">예약 상태</h3>
                <div className="flex gap-2 flex-wrap">
                  {['예약확정', '대여중', '반납완료', '취소'].map(status => (
                    <button key={status} onClick={() => handleInputChange('status', status)} className={`px-3 py-1.5 rounded-lg text-xs font-bold border transition-colors ${selectedOrder.status === status ? 'bg-gray-900 text-white border-gray-900' : 'bg-white text-gray-500 border-gray-200 hover:bg-gray-50'}`}>{status}</button>
                  ))}
                </div>
              </div>
            </div>

            <div className="p-5 border-t border-gray-100 bg-gray-50 safe-area-pb">
              <button onClick={handleSaveChanges} className="w-full bg-gray-900 text-white py-3.5 rounded-xl font-bold text-sm shadow-lg active:scale-[0.98] transition-transform flex items-center justify-center gap-2">
                <Save className="w-4 h-4" /> 변경사항 저장
              </button>
            </div>
          </div>
        </div>
      )}

      <button className="fixed bottom-6 right-6 w-12 h-12 bg-gray-900 text-white rounded-full shadow-lg flex items-center justify-center hover:bg-gray-800 transition-colors z-30">
        <span className="text-2xl font-light mb-1">+</span>
      </button>

      <style>{`
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-fadeIn { animation: fadeIn 0.2s ease-out; }
        .animate-slideUp { animation: slideUp 0.3s ease-out; }
      `}</style>
    </div>
  );
};

export default RentalAdminCompact;